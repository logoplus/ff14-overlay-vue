import{d as Ee,o as N,b as L,J as re,K as Fe,g as K,u,av as at,A as I,C as A,D as nt,F as ot,aw as it,B as st,a0 as rt,r as J,h as Ce,H as xe,a as v,w as H,a3 as lt,S as ct,I as ut,t as dt,i as mt,ax as ft,ay as Ie,c as pt}from"./vendor-5d3cd767.js";import{u as Te,t as Q,a as vt,p as bt,b as gt,d as yt,_ as ht,c as _t}from"./flags-447cb038.js";import{s as wt,h as ke}from"./xivapi-7138c80f.js";import{a as se,r as Ct}from"./overlay_plugin_api-409cb9ea.js";import{N as G,l as n}from"./netregexes-2830d8aa.js";import{g as xt}from"./actionChinese-ddfbd0ad.js";import{s as Ae,c as Le,a as It}from"./status-183ca8c7.js";import{U as ee}from"./util-4b7cb3a6.js";import"./index-b002a104.js";const kt={key:0},Nt={key:1},$t=["title","data-duration","data-sourcePov"],St=["src","alt"],Et=Ee({__name:"StatusShow",props:{row:{type:Object,required:!0}},setup(h){const _=h,$=Te().icon4k;return(V,f)=>_.row.type==="dot"?(N(),L("div",kt," （不支持） ")):(N(),L("div",Nt,[(N(!0),L(re,null,Fe(_.row.raidbuffs,(w,S)=>(N(),L("span",{key:S},[K("span",{class:"status",title:`${w.name}(${w.source})`,"data-duration":w.remainingDuration,"data-sourcePov":w.isPov},[K("img",{class:"statusIcon",src:`${u(wt).first}/i/${w.fullIcon}${u($)}.png`,alt:w.effect,loading:"lazy",onError:f[0]||(f[0]=(...R)=>u(ke)&&u(ke)(...R))},null,40,St)],8,$t)]))),128))]))}}),Ne=[{id:141,name:"战斗之声",isFriendly:!0},{id:2722,name:"光明神的最终乐章",isFriendly:!0},{id:3183,name:"夺取",isFriendly:!1},{id:2599,name:"神秘环",isFriendly:!0},{id:786,name:"战斗连祷",isFriendly:!0},{id:1910,name:"巨龙右眼",isFriendly:!0},{id:1454,name:"巨龙左眼",isFriendly:!0},{id:1185,name:"义结金兰：攻击",isFriendly:!0},{id:2703,name:"灼热之光",isFriendly:!0},{id:1221,name:"连环计",isFriendly:!1},{id:1297,name:"鼓励",isFriendly:!0},{id:1822,name:"技巧舞步结束",isFriendly:!0},{id:1825,name:"进攻之探戈",isFriendly:!0},{id:1878,name:"占卜",isFriendly:!0},{id:1882,name:"太阳神之衡",isFriendly:!0},{id:1884,name:"放浪神之箭",isFriendly:!0},{id:1885,name:"战争神之枪",isFriendly:!0},{id:1883,name:"世界树之干",isFriendly:!0},{id:1886,name:"河流神之瓶",isFriendly:!0},{id:1887,name:"建筑神之塔",isFriendly:!0}],le=new Map;let $e;function Ft(h){if($e!==h){const _=h==="Chinese"?Ne:Object.assign(Ne,{});le.clear();for(const o of _){const $=Ae[o.id][1];o.fullIcon=Le($),le.set(o.id.toString(16).toUpperCase(),o)}$e=h}}Ft("Chinese");function Tt(h){return le.get(h)}const At=/(?:攻击力|伤害)提高/,Lt=/(?:耐性|防御力)(?:大幅)?(?:降低|提升|低下|下降)|受伤(?:加重|减轻)|体力(?:增加|衰减|减少)|伤害屏障/;function Re(h,_){return Object.entries(Ae).reduce((o,[$,[V,f]])=>(h.test(V)&&o.set($,{name:V,icon:f,isFriendly:_}),o),new Map)}const Rt=Re(At,!0),Pt=Re(Lt,!1),Dt={key:0,class:"testLog"},Se="souma-raidbuff-record-2",Wt=Ee({__name:"raidbuffRecord",setup(h){const _=Te(),o={..._.userOptions},$=new URLSearchParams(window.location.href.split("?")[1]).get("filterPov")==="true",V=new URLSearchParams(window.location.href.split("?")[1]).get("onlyBuffs")==="true";_.recheckIsDev();const f=at("hash"),w=I(f.dev==="1"||f.dev===void 0&&!window.OverlayPluginApi&&!f.OVERLAY_WS&&!f.HOST_PORT);w.value&&setTimeout(()=>{w.value=f.dev==="1"||f.dev===void 0&&!window.OverlayPluginApi&&!f.OVERLAY_WS&&!f.HOST_PORT},1e3);const S=I({source:!1,action:!1}),R=I(),P=I(o.minimize),D={line_height:28*o.scale,time:35*o.scale,action:65*o.scale,source:((o.showIcon?24:0)+(o.showName?o.anonymous||!o.anonymous&&o.abbrId?24:36:0)+4)*o.scale,amount:44*o.scale,properties:32*o.scale},Pe={"--vxe-font-size-mini":`${12*o.scale}px`,"--vxe-table-row-line-height":`${30*o.scale}px`,"--vxe-table-row-height-mini":`${30*o.scale}px`,"--vxe-input-height-mini":`${20*o.scale}px`,"--vxe-select-option-height-mini":`${24*o.scale}px`},ce={runtime:99,localStorage:3},te=I(!1),B=I(),Z=A("raidbuff-record-2-pov-name",""),U=A("raidbuff-record-2-pov-id",""),ue=A("raidbuff-record-2-party-list",[]),j=A("raidbuff-record-2-job-map",{}),ae=A("raidbuff-record-2-party-event-party",[]),E=I(0),l=I([{zoneName:"",duration:"00:00",table:[],key:"init"}]),de={rsv:/^262\|(?<timestamp>[^|]*)\|[^|]*\|[^|]*\|_rsv_(?<id>\d+)_[^|]+\|(?<real>[^|]*)\|/i,ability:G.ability(),gainsEffect:G.gainsEffect(),losesEffect:G.losesEffect(),inCombat:/^260\|(?<timestamp>[^|]*)\|(?<inACTCombat>[^|]*)\|(?<inGameCombat>[^|]*)\|/,changeZone:G.changeZone(),partyList:/^11\|(?<timestamp>[^|]*)\|(?<partyCount>\d*)\|(?<list>(?:\w{8}\|)*)\w{16}/,primaryPlayer:/^02\|(?<timestamp>[^|]*)\|(?<id>[^|]*)\|(?<name>[^|]*)/,addCombatant:G.addedCombatant(),removingCombatant:G.removingCombatant()},C=I(0),me=A("souma-raidbuff-record-2-zone-name",""),fe=A("souma-raidbuff-record-2-rsv-data",{}),x={friendly:{},enemy:{}};function De(e){e.table.length=0,e.zoneName="",e.duration="00:00",e.key="init"}function je(){te.value=!0,C.value=0,E.value=0,l.value.length=1,De(l.value[0])}function ze(){ge(),te.value=!1}function pe(e){ve(e.rawLine)}function ve(e){var a,s,m;for(const y in de){const b=de[y].exec(e);if(b){const t=e.split("|");switch(y){case"gainsEffect":{const r=t[n.GainsEffect.fields.effectId],c=t[n.GainsEffect.fields.effect],i=t[n.GainsEffect.fields.target],d=t[n.GainsEffect.fields.targetId],p=Number(t[n.GainsEffect.fields.count]);let g=Tt(r);if(!g){const M=d.startsWith("1")&&Rt.get(Number.parseInt(r,16).toString())||d.startsWith("4")&&Pt.get(Number.parseInt(r,16).toString());if(!M)return;const W=Le(M.icon),ie=p>1?It(W,p):W;g={id:Number.parseInt(r,16),fullIcon:ie,name:M.name,isFriendly:M.isFriendly}}const z=t[n.GainsEffect.fields.duration],k=t[n.GainsEffect.fields.source],O=t[n.GainsEffect.fields.sourceId],oe=new Date(t[n.GainsEffect.fields.timestamp]).getTime()+Number.parseFloat(z)*1e3,q={name:g.name,count:p,effect:c,effectId:r,source:k,sourceId:O,target:i,targetId:d,expirationTimestamp:oe,fullIcon:g.fullIcon,isPov:U.value===O};d.startsWith("1")&&g.isFriendly?((a=x.friendly)[d]??(a[d]={}))[r]=q:d.startsWith("4")&&!g.isFriendly&&(((s=x.enemy)[i]??(s[i]={}))[r]=q)}break;case"losesEffect":{const r=t[n.LosesEffect.fields.target],c=t[n.LosesEffect.fields.targetId],i=t[n.LosesEffect.fields.effectId];c.startsWith("1")?x.friendly[c]&&Reflect.deleteProperty(x.friendly[c],i):x.enemy[r]&&Reflect.deleteProperty(x.enemy[r],i)}break;case"addCombatant":if(t[n.AddedCombatant.fields.job]!=="00"){const r=t[n.AddedCombatant.fields.job],c=new Date(t[n.AddedCombatant.fields.timestamp]).getTime();j.value[t[n.AddedCombatant.fields.id]]={job:Number.parseInt(r,16),timestamp:c}}break;case"removingCombatant":Reflect.deleteProperty(j.value,t[n.RemovedCombatant.fields.id]);break;case"primaryPlayer":{U.value=t[n.ChangedPlayer.fields.id];const r=t[n.ChangedPlayer.fields.name];if(Z.value===r)return;Z.value=r,_.initEnvironment(t[n.ChangedPlayer.fields.name])}break;case"partyList":ue.value=((m=b.groups.list)==null?void 0:m.split("|"))??[];break;case"changeZone":me.value=t[n.ChangeZone.fields.name],be(new Date(t[n.ChangeZone.fields.timestamp]).getTime());break;case"inCombat":{const r=t[n.InCombat.fields.inACTCombat]==="1",c=t[n.InCombat.fields.inGameCombat]==="1",i=new Date(t[n.InCombat.fields.timestamp]).getTime();if(r||c){if(C.value>0)return;l.value[0].table.length!==0&&(l.value[0]=ft(l.value[0]),l.value.unshift({zoneName:"",duration:"00:00",table:[],key:t[n.InCombat.fields.timestamp]}),l.value.length>=ce.runtime&&l.value.splice(l.value.length-1,1)),C.value=i,l.value[0].zoneName=me.value,E.value=0;const d=B.value;d&&$&&d.updateData().then(()=>{const p=d.getColumnByField("source");if(p){const g=p.filters.find(z=>z.value===Z.value);if(!g)return;g.checked=!0,d.updateData().then(()=>{S.value.source=!0})}});return}if(!r&&!c){be(i);return}}break;case"rsv":{const r=Number(b.groups.id),c=t[n.RSVData.fields.value];fe.value[Number(r)]=c}break;case"ability":if(C.value===0)return;{const r=bt(t);if(r.isAttack&&r.amount>=0){const c=t[n.Ability.fields.sourceId]??"???",i=t[n.Ability.fields.targetId]??"???";if(!(c.startsWith("1")&&i.startsWith("4"))||!(c===U.value||ue.value.includes(c)||ae.value.find(T=>T.id===c)))return;const d=new Date(t[n.Ability.fields.timestamp]??"???").getTime(),p=t[n.Ability.fields.ability],g=p.match(/^_rsv_(?<id>\d+)_/),z=t[n.Ability.fields.id]??"???";let k=p;if(g){const T=Number(g.groups.id);k=fe.value[T]??p.match(/^_(?<id>rsv_\d+)_/).groups.id}else if(k=k.replace(/unknown_.*/,"攻击"),o.parseAA===!1&&/^攻击|攻撃|[Aa]ttack$/.test(k))return;const O=xt(Number.parseInt(z,16)),ye=O&&O!==""?O:k,oe=Number(t[n.Ability.fields.targetCurrentHp])??"???",q=Number(t[n.Ability.fields.targetMaxHp])??"???",M=t[n.Ability.fields.source]??"???",W=t[n.Ability.fields.target]??"???",{effect:ie,type:Ye,properties:qe}=gt(r.flags),Xe=C.value===0?0:d-C.value,Qe=ne(Xe),he=Oe(c),et=ee.nameToFullName(ee.jobEnumToJob(he)).cn.substring(0,2),_e=he,tt=ee.jobEnumToIcon(_e).toLocaleLowerCase(),we=yt(Object.values(x.friendly[c]??[]).concat(Object.values(x.enemy[W]??[])).filter(T=>{const X=Math.max(0,(T.expirationTimestamp-d)/1e3);return T.remainingDuration=X>=999?"":X.toFixed(X>.05&&X<.95?1:0),Number(T.remainingDuration)>-3}));if(V&&we.length===0)return;Me({timestamp:d,time:Qe,id:z,action:k,actionCN:ye,source:M,target:W,sourceId:c,job:et,jobIcon:tt,jobEnum:_e,amount:r.amount,raidbuffs:we,currentHp:oe,maxHp:q,effect:ie,properties:qe,type:Ye,povId:U.value}),l.value[0].duration=ne(new Date(t[n.Ability.fields.timestamp]).getTime()-C.value)}break}}}}}function Oe(e){const a=j.value[e],s=ae.value.find(m=>m.id===e)??{job:0,timestamp:0};return[a,s].sort((m,y)=>y.timestamp-m.timestamp)[0].job}function Me(e){l.value[0].table.unshift(e)}function be(e){C.value!==0&&(l.value[0].duration=ne(e-C.value),C.value=0,x.friendly={},x.enemy={},ge())}function ge(){localStorage.setItem(Se,JSON.stringify(l.value.slice(0,ce.localStorage)))}function He(){const e=localStorage.getItem(Se);if(e)try{const a=JSON.parse(e);l.value.length=0,l.value.push(...a)}catch(a){console.error(a)}}function ne(e){const a=Math.max(Math.floor(e/6e4),0),s=Math.max(Math.floor((e-a*6e4)/1e3),0);return`${a<10?"0":""}${a}:${s<10?"0":""}${s}`}const Ge=nt(()=>{const e={},a=new Set(l.value[E.value].table.slice().sort((s,m)=>ee.enumSortMethod(s.jobEnum,m.jobEnum)).map(s=>(e[s.source]=s.job,s.source)));return Array.from(a).map(s=>({label:`${e[s]}（${s}）`,value:s}))});function Ve(e){Z.value=e.charName,U.value=e.charID.toString(16).toUpperCase()}function Be(e){ae.value=e.party.map(a=>({...a,timestamp:Date.now()}))}ot(()=>{for(const e in j.value){const a=j.value[e];Date.now()-a.timestamp>1e3*60*60*24*1&&Reflect.deleteProperty(j.value,e)}He(),se("LogLine",pe),se("PartyChanged",Be),se("ChangePrimaryPlayer",Ve)}),it(()=>{Ct("LogLine",pe)});function Ue(e){const{action:a,actionCN:s,amount:m,job:y,raidbuffs:F,source:b,time:t,type:r,properties:c}=e,i=e.effect==="damage done"?"":`,${Q(e.effect)}`,d=`${t} [${y}]${b}的“${a}${s!==a?`(${s})`:""}”造成${m.toLocaleString()}点${Q(r)}${Q(c)}伤害。团辅：${F.length===0&&i===""?"无":F.map(p=>o.statusCN?p.name:p.effect).join(",")+i}。`;We(d)}function We(e){navigator.clipboard.writeText(e).catch(()=>{const a=document.createElement("input");a.value=e,document.body.appendChild(a),a.select(),document.execCommand("copy"),document.body.removeChild(a)}),Ie.modal.message({content:"已复制到剪贴板",status:"success"})}const Y=st({className:"my-menus",body:{options:[]}});rt(()=>{var e;Y.body&&Y.body.options&&B.value&&(Y.body.options[0]=[{code:"copy",name:"复制详情",prefixIcon:"vxe-icon-copy",className:"my-copy-item"},{code:"clearFilterTarget",name:"取消玩家筛选",prefixIcon:"vxe-icon-funnel-clear",visible:S.value.source,disabled:!1},{code:"filterSelectTarget",name:(e=R.value)!=null&&e.source?`只看[${R.value.job}] ${R.value.source}`:"只看该玩家",prefixIcon:"vxe-icon-user-fill",visible:!S.value.source,disabled:!1}])});function Je(){P.value=!P.value}const Ke=({row:e})=>{const a=B.value;a&&(a.setCurrentRow(e),R.value=e)},Ze=({menu:e,row:a})=>{const s=B.value;switch(e.code){case"copy":if(!a){Ie.modal.message({content:"未选中有效数据行",status:"error"});return}Ue(a);break;case"clearFilterTarget":s&&(s.clearFilter(s.getColumnByField("source")),S.value.source=!1);break;case"filterSelectTarget":if(s){const m=s.getColumnByField("source");if(m){const y=m.filters.find(F=>F.value===a.source);if(!y)return;y.checked=!0,s.updateData().then(()=>{s.scrollToRow(a),S.value.source=!0})}}break}};return(e,a)=>{const s=J("vxe-option"),m=J("vxe-select"),y=J("vxe-button"),F=ht,b=J("vxe-column"),t=_t,r=Et,c=J("vxe-table");return N(),L(re,null,[K("div",{class:"wrapper",style:Pe},[K("header",null,[Ce(v(m,{modelValue:u(E),"onUpdate:modelValue":a[0]||(a[0]=i=>lt(E)?E.value=i:null),size:"mini",class:"select"},{default:H(()=>[(N(!0),L(re,null,Fe(u(l).length,i=>(N(),pt(s,{key:`${u(l)[i-1].key}-${u(l)[i-1].duration}-${u(l)[i-1].zoneName}`,value:i-1,label:`${u(l)[i-1].duration} ${u(l)[i-1].zoneName}`},null,8,["value","label"]))),128))]),_:1},8,["modelValue"]),[[xe,!u(P)]]),v(y,{class:"minimize",icon:u(P)?"vxe-icon-fullscreen":"vxe-icon-minimize",style:ct({opacity:u(P)?.5:1}),onClick:Je},null,8,["icon","style"])]),Ce(K("main",null,[v(c,{ref_key:"xTable",ref:B,size:"mini",class:"vxe-table","show-overflow":"tooltip",round:"",height:"100%","scroll-y":{enabled:!0},loading:u(te),"show-header":o.showHeader,data:u(l)[u(E)].table,"row-config":{isHover:!0,height:D.line_height},"header-cell-style":{padding:"0px"},"menu-config":u(Y),onCellMenu:Ke,onMenuClick:Ze},{default:H(()=>[v(b,{width:D.source,field:"source",title:o.showName?"友方":"友",filters:u(Ge),"filter-multiple":!1,resizable:!o.anonymous&&!o.abbrId,align:"left","header-align":"center"},{default:H(({row:i})=>[v(F,{row:i},null,8,["row"])]),_:1},8,["width","title","filters","resizable"]),v(b,{width:D.time,field:"time",title:"时间",align:"center"},null,8,["width"]),v(b,{width:D.action,field:o.actionCN?"actionCN":"action",title:"技能",resizable:!1,align:"right"},null,8,["width","field"]),v(b,{width:D.amount,title:"伤害","header-align":"center"},{default:H(({row:i})=>[v(t,{row:i},null,8,["row"])]),_:1},8,["width"]),v(b,{width:D.properties,title:"直暴","header-align":"center",align:"center"},{default:H(({row:i})=>[ut(dt(u(Q)(i.properties).replace(/普通$/,"").replace("直击","直　").replace("暴击","　暴")),1)]),_:1},8,["width"]),v(b,{title:"团辅",align:"left"},{default:H(({row:i})=>[v(r,{row:i},null,8,["row"])]),_:1})]),_:1},8,["loading","show-header","data","row-config","menu-config"])],512),[[xe,!u(P)]])]),u(w)?(N(),L("div",Dt,[v(vt,{onBeforeHandle:je,onAfterHandle:ze,onHandleLine:ve})])):mt("",!0)],64)}}});export{Wt as default};
