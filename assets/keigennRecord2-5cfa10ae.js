import{d as Fe,o as w,b as E,J as Ce,K as He,g as ae,t as at,u as s,R as nt,D as ye,A as L,C as B,F as ot,B as it,a0 as st,r as te,h as Ae,H as Se,a as g,w as D,a3 as lt,S as rt,i as he,I as fe,ax as ct,ay as je,c as ut}from"./vendor-5d3cd767.js";import{u as Re,t as _e,m as mt,a as dt,p as ft,b as pt,d as gt,g as vt,e as bt,f as yt,_ as ht,c as kt}from"./flags-447cb038.js";import{s as Ct,h as Le}from"./xivapi-7138c80f.js";import{N as z,l as n}from"./netregexes-2830d8aa.js";import{a as ke}from"./overlay_plugin_api-409cb9ea.js";import{U as M}from"./util-4b7cb3a6.js";import{g as _t}from"./actionChinese-ddfbd0ad.js";import{c as xt,a as It}from"./status-183ca8c7.js";import"./index-b002a104.js";const wt={key:0},Nt={key:1},$t=["title","data-duration","data-sourcePov"],Tt=["src","alt"],Dt=Fe({__name:"StatusShow",props:{row:{type:Object,required:!0}},setup(Y){const k=Y,F=Re().icon4k;return(H,A)=>k.row.type==="dot"?(w(),E("div",wt," （不支持） ")):(w(),E("div",Nt,[(w(!0),E(Ce,null,He(k.row.keigenns,(N,ne)=>(w(),E("span",{key:ne},[ae("span",{class:"status",title:`${N.name}(${N.source})`,"data-duration":N.remainingDuration,"data-sourcePov":N.isPov},[ae("img",{class:nt(`statusIcon ${s(mt)(N.performance[Y.row.type])}`),src:`${s(Ct).first}/i/${N.fullIcon}${s(F)}.png`,alt:N.effect,loading:"lazy",onError:A[0]||(A[0]=(...Q)=>s(Le)&&s(Le)(...Q))},null,42,Tt)],8,$t)]))),128)),ae("span",null,at(Y.row.effect==="damage done"?"":s(_e)(Y.row.effect)),1)]))}}),Et={key:0},At={key:0,class:"testLog"},St={key:0,class:"test-buttons"},ze="souma-keigenn-record-2",Gt=Fe({__name:"keigennRecord2",setup(Y){const k=Re(),r=k.userOptions;k.recheckIsDev();const F=ye(()=>r.actionCN?"actionCN":"action"),H=L(r.minimize),A={line_height:28*r.scale,time:35*r.scale,action:65*r.scale,target:((r.showIcon?24:0)+(r.showName?r.anonymous||!r.anonymous&&r.abbrId?24:36:0)+7)*r.scale,amount:44*r.scale},N={"--vxe-font-size-mini":`${12*r.scale}px`,"--vxe-table-row-line-height":`${30*r.scale}px`,"--vxe-table-row-height-mini":`${30*r.scale}px`,"--vxe-input-height-mini":`${20*r.scale}px`,"--vxe-select-option-height-mini":`${24*r.scale}px`},ne={runtime:99,localStorage:3},Q=L(!1),oe=L(),_=B("keigenn-record-2-pov-name",""),C=B("keigenn-record-2-pov-id",""),pe=B("keigenn-record-2-party-list",[]),G=B("keigenn-record-2-job-map",{}),ie=B("keigenn-record-2-party-event-party",[]),$=L(0),i=L([{zoneName:"",duration:"00:00",table:[],key:"init"}]),xe={rsv:/^262\|(?<timestamp>[^|]*)\|[^|]*\|[^|]*\|_rsv_(?<id>\d+)_[^|]+\|(?<real>[^|]*)\|/i,ability:z.ability(),statusEffectExplicit:z.statusEffectExplicit(),gainsEffect:z.gainsEffect(),losesEffect:z.losesEffect(),inCombat:/^260\|(?<timestamp>[^|]*)\|(?<inACTCombat>[^|]*)\|(?<inGameCombat>[^|]*)\|/,changeZone:z.changeZone(),partyList:/^11\|(?<timestamp>[^|]*)\|(?<partyCount>\d*)\|(?<list>(?:\w{8}\|)*)\w{16}/,primaryPlayer:/^02\|(?<timestamp>[^|]*)\|(?<id>[^|]*)\|(?<name>[^|]*)/,addCombatant:z.addedCombatant(),removingCombatant:z.removingCombatant(),networkDoT:z.networkDoT()},b=L(0),Ie=B("souma-keigenn-record-2-zone-name",""),we=B("souma-keigenn-record-2-rsv-data",{}),ge={},p={friendly:{},enemy:{}};function Pe(e){e.table.length=0,e.zoneName="",e.duration="00:00",e.key="init"}function Be(){Q.value=!0,b.value=0,$.value=0,i.value.length=1,Pe(i.value[0])}function Me(){le(),Q.value=!1}function se(e){var t,o,u,f,v,V,J,W,K,m;for(const ue in xe){const R=xe[ue].exec(e);if(R){const a=e.split("|");switch(ue){case"statusEffectExplicit":(t=R.groups)!=null&&t.targetId.startsWith("1")&&(ge[(o=R.groups)==null?void 0:o.targetId]=(u=R.groups)==null?void 0:u.currentShield);break;case"gainsEffect":{const l=a[n.GainsEffect.fields.effectId],c=a[n.GainsEffect.fields.effect],d=a[n.GainsEffect.fields.target],y=a[n.GainsEffect.fields.targetId],T=Number.parseInt(a[n.GainsEffect.fields.count],16);let h=vt(l);if(!h){const I=y.startsWith("1")&&bt.get(Number.parseInt(l,16).toString())||y.startsWith("4")&&yt.get(Number.parseInt(l,16).toString());if(!I)return;const X=xt(I.icon),ee=T>1?It(X,T):X;h={type:"multiplier",performance:{physics:1,magic:1,darkness:1},id:Number.parseInt(l,16),fullIcon:ee,name:I.name,isFriendly:I.isFriendly}}const U=a[n.GainsEffect.fields.duration],x=a[n.GainsEffect.fields.source],j=a[n.GainsEffect.fields.sourceId],Z=new Date(a[n.GainsEffect.fields.timestamp]).getTime()+Number.parseFloat(U)*1e3,q={name:h.name,count:T,effect:c,effectId:l,source:x,sourceId:j,target:d,targetId:y,expirationTimestamp:Z,performance:h.performance,fullIcon:h.fullIcon,isPov:C.value===j};y.startsWith("1")&&h.isFriendly?(p.friendly[y]===void 0&&(p.friendly[y]={}),p.friendly[y][l]=q):y.startsWith("4")&&!h.isFriendly&&(p.enemy[d]===void 0&&(p.enemy[d]={}),p.enemy[d][l]=q)}break;case"losesEffect":{const l=a[n.LosesEffect.fields.target],c=a[n.LosesEffect.fields.targetId],d=a[n.LosesEffect.fields.effectId];c.startsWith("1")?p.friendly[c]&&Reflect.deleteProperty(p.friendly[c],d):p.enemy[l]&&Reflect.deleteProperty(p.enemy[l],d)}break;case"addCombatant":if(a[n.AddedCombatant.fields.job]!=="00"){const l=a[n.AddedCombatant.fields.job],c=new Date(a[n.AddedCombatant.fields.timestamp]).getTime();G.value[a[n.AddedCombatant.fields.id]]={job:Number.parseInt(l,16),timestamp:c}}break;case"removingCombatant":Reflect.deleteProperty(G.value,a[n.RemovedCombatant.fields.id]);break;case"primaryPlayer":{C.value=a[n.ChangedPlayer.fields.id];const l=a[n.ChangedPlayer.fields.name];if(_.value===l)return;_.value=l,k.initEnvironment(a[n.ChangedPlayer.fields.name]);break}case"partyList":pe.value=((v=(f=R.groups)==null?void 0:f.list)==null?void 0:v.split("|"))??[];break;case"changeZone":Ie.value=a[n.ChangeZone.fields.name],Te(new Date(a[n.ChangeZone.fields.timestamp]).getTime());break;case"inCombat":{const l=a[n.InCombat.fields.inACTCombat]==="1",c=a[n.InCombat.fields.inGameCombat]==="1",d=new Date(a[n.InCombat.fields.timestamp]).getTime();if(l||c){if(b.value>0)return;i.value[0].key==="placeholder"&&i.value.splice(0,1),i.value[0].table.length!==0&&(i.value[0]=ct(i.value[0]),i.value.unshift({zoneName:"",duration:"00:00",table:[],key:a[n.InCombat.fields.timestamp]}),i.value.length>=ne.runtime&&i.value.splice(i.value.length-1,1)),b.value=d,i.value[0].zoneName=Ie.value,$.value=0;return}if(!l&&!c){Te(d);return}}break;case"rsv":{const l=Number((V=R.groups)==null?void 0:V.id),c=a[n.RSVData.fields.value];we.value[Number(l)]=c}break;case"networkDoT":if(!r.parseDoT)return;{const l=a[n.NetworkDoT.fields.which],c=a[n.NetworkDoT.fields.id];if(l!=="DoT"||c.startsWith("4")||!(c===C.value||pe.value.includes(c)||ie.value.find(ee=>ee.id===c)))return;const d=a[n.NetworkDoT.fields.name],y=a[n.NetworkDoT.fields.damage],T=Number.parseInt(y,16),h=new Date(a[n.Ability.fields.timestamp]??"???").getTime(),U=Number(a[n.NetworkDoT.fields.currentHp]),x=Number(a[n.NetworkDoT.fields.maxHp]),j=b.value===0?0:h-b.value,me=re(j),Z=Ne(c),q=M.nameToFullName(M.jobEnumToJob(Z)).simple2,I=Z,X=M.jobEnumToIcon(I).toLowerCase();$e({timestamp:h,time:me,id:void 0,action:l,actionCN:l,source:"",target:d,targetId:c,job:q,jobIcon:X,jobEnum:I,amount:T,keigenns:[],currentHp:U,maxHp:x,effect:"damage done",type:"dot",shield:ge[c],povId:C.value})}break;case"ability":if(b.value===0)return;{const l=ft(a);if(l.isAttack&&l.amount>=0){const c=a[n.Ability.fields.sourceId]??"???",d=a[n.Ability.fields.targetId]??"???";if(!(c.startsWith("4")&&d.startsWith("1"))||!(d===C.value||pe.value.includes(d)||ie.value.find(P=>P.id===d)))return;const y=new Date(a[n.Ability.fields.timestamp]??"???").getTime(),T=a[n.Ability.fields.ability],h=T.match(/^_rsv_(?<id>\d+)_/),U=a[n.Ability.fields.id]??"???";let x=T;if(h){const P=Number((J=h.groups)==null?void 0:J.id);x=we.value[P]??((K=(W=T.match(/^_(?<id>rsv_\d+)_/))==null?void 0:W.groups)==null?void 0:K.id)}else if(x=x.replace(/unknown_.*/,"攻击"),r.parseAA===!1&&/^攻击|攻撃|[Aa]ttack$/.test(x))return;const j=_t(Number.parseInt(U,16)),me=j&&j!==""?j:x,Z=Number(a[n.Ability.fields.targetCurrentHp])??"???",q=Number(a[n.Ability.fields.targetMaxHp])??"???",I=a[n.Ability.fields.source]??"???",X=a[n.Ability.fields.target]??"???",{effect:ee,type:qe}=pt(l.flags),Xe=b.value===0?0:y-b.value,Ye=re(Xe),De=Ne(d),Qe=M.nameToFullName(M.jobEnumToJob(De)).cn.substring(0,2),Ee=De,et=M.jobEnumToIcon(Ee).toLowerCase(),tt=gt(Object.values(p.friendly[d]??[]).concat(Object.values(p.enemy[I]??[])).filter(P=>{const de=Math.max(0,(P.expirationTimestamp-y)/1e3);return P.remainingDuration=de>=999?"":de.toFixed(de>.05&&de<.95?1:0),Number(P.remainingDuration)>-3}));$e({timestamp:y,time:Ye,id:U,action:x,actionCN:me,source:I,target:X,targetId:d,job:Qe,jobIcon:et,jobEnum:Ee,amount:l.amount,keigenns:tt,currentHp:Z,maxHp:q,effect:ee,type:qe,shield:ge[((m=R.groups)==null?void 0:m.targetId)??""],povId:C.value}),i.value[0].duration=re(new Date(a[n.Ability.fields.timestamp]).getTime()-b.value)}break}}}}}function Ne(e){const t=G.value[e],o=ie.value.find(u=>u.id===e)??{job:0,timestamp:0};return[t,o].sort((u,f)=>f.timestamp-u.timestamp)[0].job}function $e(e){i.value[0].table.unshift(e)}function Te(e){b.value!==0&&(i.value[0].duration=re(e-b.value),b.value=0,p.friendly={},p.enemy={},le())}function le(){localStorage.setItem(ze,JSON.stringify(i.value.slice(0,ne.localStorage)))}function Ge(){const e=localStorage.getItem(ze);if(e)try{const t=JSON.parse(e);i.value.length=0,i.value.push(...t)}catch(t){console.error(t)}}function re(e){const t=Math.max(Math.floor(e/6e4),0),o=Math.max(Math.floor((e-t*6e4)/1e3),0);return`${t<10?"0":""}${t}:${o<10?"0":""}${o}`}const Oe=ye(()=>{const e=new Set(i.value[$.value].table.map(t=>r.actionCN?t.actionCN:t.action));return Array.from(e).map(t=>({label:t,value:t}))}),Ve=ye(()=>{const e={},t=new Set(i.value[$.value].table.slice().sort((o,u)=>M.enumSortMethod(o.jobEnum,u.jobEnum)).map(o=>(e[o.target]=o.job,o.target)));return Array.from(t).map(o=>({label:`${e[o]}（${o}）`,value:o}))});k.isBrowser&&(_.value="测试用户"),_.value!==""&&k.initEnvironment(_.value),ot(()=>{for(const e in G.value){const t=G.value[e];Date.now()-t.timestamp>1e3*60*60*24*1&&Reflect.deleteProperty(G.value,e)}Ge(),!k.isBrowser&&i.value[0].key!=="placeholder"&&i.value.unshift({duration:"00:00",table:[],zoneName:"",key:"placeholder"}),ke("LogLine",e=>{se(e.rawLine)}),ke("PartyChanged",e=>{ie.value=e.party.map(t=>({...t,timestamp:Date.now()}))}),ke("ChangePrimaryPlayer",e=>{_.value=e.charName,C.value=Number(e.charID).toString(16).toUpperCase()})});function Je(e){const{action:t,actionCN:o,amount:u,job:f,keigenns:v,source:V,target:J,time:W,type:K}=e,m=e.effect==="damage done"?"":`,${_e(e.effect)}`,ue=`${W} [${f}]${J} HP:${e.currentHp}/${e.maxHp}(${Math.round(e.currentHp/e.maxHp*100)}%)+盾:${Math.round(e.maxHp*+e.shield/100)}(${e.shield}%),受到${V}“${t}${o!==t?`(${o})`:""}”的 ${u.toLocaleString()} 点${_e(K)}伤害。减伤:${v.length===0&&m===""?"无":v.map(be=>r.statusCN?be.name:be.effect).join(",")+m}`;We(ue)}function We(e){navigator.clipboard.writeText(e).catch(()=>{const t=document.createElement("input");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}),je.modal.message({content:"已复制到剪贴板",status:"success"})}const S=L({target:!1,action:!1}),O=L(),ve=it({className:"my-menus",body:{options:[]}});st(()=>{var e,t,o,u;(e=ve.body)!=null&&e.options&&oe.value&&(ve.body.options[0]=[{code:"copy",name:"复制详情",prefixIcon:"vxe-icon-copy",className:"my-copy-item"},{code:"clearFilterAction",name:"取消技能筛选",prefixIcon:"vxe-icon-funnel-clear",className:"my-clear-filter",visible:S.value.action,disabled:!1},{code:"filterSelectAction",name:(t=O.value)!=null&&t[F.value]?`只看 ${(o=O.value)==null?void 0:o[F.value]}`:"只看该技能",prefixIcon:"vxe-icon-info-circle",visible:!S.value.action,disabled:!1},{code:"clearFilterTarget",name:"取消玩家筛选",prefixIcon:"vxe-icon-funnel-clear",visible:S.value.target,disabled:!1},{code:"filterSelectTarget",name:(u=O.value)!=null&&u.target?`只看[${O.value.job}] ${O.value.target}`:"只看该玩家",prefixIcon:"vxe-icon-user-fill",visible:!S.value.target,disabled:!1}])});function Ke(){H.value=!H.value}const Ue=({row:e})=>{const t=oe.value;t&&(t.setCurrentRow(e),O.value=e)},Ze=({menu:e,row:t})=>{const o=oe.value;switch(e.code){case"copy":if(!t){je.modal.message({content:"未选中有效数据行",status:"error"});return}Je(t);break;case"clearFilterTarget":o&&(o.clearFilter(o.getColumnByField("target")),S.value.target=!1);break;case"clearFilterAction":o&&(o.clearFilter(o.getColumnByField(F.value)),S.value.action=!1);break;case"filterSelectTarget":if(o){const u=o.getColumnByField("target");if(u){const f=u.filters.find(v=>v.value===t.target);if(!f)return;f.checked=!0,o.updateData().then(()=>{o.scrollToRow(t),S.value.target=!0})}}break;case"filterSelectAction":if(o){const u=o.getColumnByField(F.value);if(u){const f=u.filters.find(v=>v.value===t[F.value]);if(!f)return;f.checked=!0,o.updateData().then(()=>{o.scrollToRow(t),S.value.action=!0})}}break}},ce={clearData:()=>{$.value=0,i.value.length=0,i.value.push({key:Date.now().toString(),zoneName:"测试地区",duration:"00:00",table:[]}),b.value=0,p.friendly={},p.enemy={},le()},fakeData:()=>{i.value[0].table.push({timestamp:1e4,time:i.value[0].table.length.toString(),id:void 0,action:"测试动作",actionCN:"测试动作",source:"测试敌人",target:_.value,targetId:"1234567890",job:"战士",jobIcon:"warrior",jobEnum:0,amount:1e3,keigenns:[{name:"整体盾",count:0,effect:"整体盾",effectId:"D25",source:"芸豆角包子",sourceId:"1011A008",target:"芸豆角包子",targetId:"1011A008",expirationTimestamp:1712757148883,performance:{physics:1,magic:1,darkness:1},fullIcon:"012000/012972",isPov:!1,remainingDuration:"14"},{name:"整体论",count:0,effect:"整体论",effectId:"BBB",source:"芸豆角包子",sourceId:"1011A008",target:"芸豆角包子",targetId:"1011A008",expirationTimestamp:1712757138883,performance:{physics:1,magic:1,darkness:1},fullIcon:"012000/012971",isPov:!1,remainingDuration:"4"},{name:"均衡预后",count:0,effect:"均衡预后",effectId:"A31",source:"芸豆角包子",sourceId:"1011A008",target:"芸豆角包子",targetId:"1011A008",expirationTimestamp:1712757153915,performance:{physics:1,magic:1,darkness:1},fullIcon:"012000/012954",isPov:!1,remainingDuration:"19"}],currentHp:1e3,maxHp:1e3,effect:"damage done",type:"magic",shield:"0",povId:C.value}),le()},fakeLogDamage:()=>{b.value=Date.now(),se(`21|${new Date}|4000044A|万魔殿|829A|尖脚|${C.value}|${_.value}|720203|B0F10000|9F0E|8200000|1B|829A8000|0|0|0|0|0|0|0|0|0|0|155065|155065|10000|10000|||94.62|98.28|0.00|-3.13|44|44|0|10000|||92.00|100.00|0.00|0.00|000010B3|0|1|fd5fa47ff773c3ca`)},fakeLogStatus:()=>{se(`26|${new Date}|59|复仇|15.00|${C.value}|${_.value}|${C.value}|${_.value}|64|129221|129221|b6388ee76760c33b`)}};return(e,t)=>{const o=te("vxe-option"),u=te("vxe-select"),f=te("vxe-button"),v=te("vxe-column"),V=ht,J=kt,W=Dt,K=te("vxe-table");return w(),E(Ce,null,[ae("div",{class:"wrapper",style:N},[s(r).showHeader?(w(),E("header",Et,[Ae(g(u,{modelValue:s($),"onUpdate:modelValue":t[0]||(t[0]=m=>lt($)?$.value=m:null),size:"mini",class:"select"},{default:D(()=>[(w(!0),E(Ce,null,He(s(i).length,m=>(w(),ut(o,{key:`${s(i)[m-1].key}-${s(i)[m-1].duration}-${s(i)[m-1].zoneName}`,value:m-1,label:`${s(i)[m-1].duration} ${s(i)[m-1].zoneName}`},null,8,["value","label"]))),128))]),_:1},8,["modelValue"]),[[Se,!s(H)]]),g(f,{class:"minimize",icon:s(H)?"vxe-icon-fullscreen":"vxe-icon-minimize",style:rt({opacity:s(H)?.5:1}),onClick:Ke},null,8,["icon","style"])])):he("",!0),Ae(ae("main",null,[g(K,{ref_key:"xTable",ref:oe,size:"mini",class:"vxe-table","show-overflow":"tooltip",round:"",height:"100%","scroll-y":{enabled:!0},loading:s(Q),"show-header":s(r).showHeader,data:s(i)[s($)].table,"row-config":{isHover:!0,height:A.line_height},"header-cell-style":{padding:"0px"},"menu-config":s(ve),onCellMenu:Ue,onMenuClick:Ze},{default:D(()=>[g(v,{width:A.time,field:"time",title:"时间",align:"center"},null,8,["width"]),g(v,{width:A.action,field:s(r).actionCN?"actionCN":"action",title:"技能",filters:s(Oe),"filter-multiple":!1,resizable:!1,align:"center"},null,8,["width","field","filters"]),g(v,{width:A.target,field:"target",title:s(r).showName?"目标":"目",filters:s(Ve),"filter-multiple":!1,resizable:!s(r).anonymous&&!s(r).abbrId,align:"left","header-align":"center"},{default:D(({row:m})=>[g(V,{row:m},null,8,["row"])]),_:1},8,["width","title","filters","resizable"]),g(v,{width:A.amount,title:"伤害","header-align":"center"},{default:D(({row:m})=>[g(J,{row:m},null,8,["row"])]),_:1},8,["width"]),g(v,{title:"减伤",align:"left"},{default:D(({row:m})=>[g(W,{row:m},null,8,["row"])]),_:1})]),_:1},8,["loading","show-header","data","row-config","menu-config"])],512),[[Se,!s(H)]])]),s(k).isBrowser?(w(),E("div",At,[s(k).isLocalhost?(w(),E("div",St,[g(f,{class:"test-button",type:"primary",onClick:ce.clearData},{default:D(()=>[fe(" 清空 ")]),_:1},8,["onClick"]),g(f,{class:"test-button",type:"primary",onClick:ce.fakeData},{default:D(()=>[fe(" 假条目 ")]),_:1},8,["onClick"]),g(f,{class:"test-button",type:"primary",onClick:ce.fakeLogDamage},{default:D(()=>[fe(" 假伤害 ")]),_:1},8,["onClick"]),g(f,{class:"test-button",type:"primary",onClick:ce.fakeLogStatus},{default:D(()=>[fe(" 假状态 ")]),_:1},8,["onClick"])])):he("",!0),g(dt,{onBeforeHandle:Be,onAfterHandle:Me,onHandleLine:se})])):he("",!0)],64)}}});export{Gt as default};
