import{U as f}from"./util-4b7cb3a6.js";const h=new URLSearchParams(window.location.href.split("?")[1]),s=h.get("api"),a={cafe:"cafemaker.wakingsands.com",xivapi:"xivapi.com"},c={first:`https://${(s==null?void 0:s.toLowerCase())==="xivapi"?a.xivapi:a.cafe}`,second:`https://${(s==null?void 0:s.toLowerCase())==="xivapi"?a.cafe:a.xivapi}`},I={get random(){return Math.floor(Math.random()*864e5*11)+864e5*25}},w=new Map(Object.entries({任务指令:"/i/000000/000123.png",冲刺:"/i/000000/000104.png",坐骑:"/i/000000/000118.png",攻击:"/i/000000/000101.png",腐秽大地:"/i/003000/003090.png"})),m="souma-action-cache",l=JSON.parse(localStorage.getItem(m)||"[]"),$=Date.now(),y=1e3,A=l.filter((e,t)=>e.expirationTime>=$&&t<y);localStorage.setItem(m,JSON.stringify(A));const C=/(\d{6})\/(\d{6})\.png$/;async function T(e,t,o=["ID","Icon","ActionCategoryTargetID"]){const r=D(e,t,o);try{return await(await p(r,{mode:"cors"})).json()}catch(n){return console.error(`Failed to parse action: ${n}`),Promise.resolve({ActionCategoryTargetID:0,ID:t,Icon:"/i/000000/000405.png"})}}function D(e,t,o){const r=`${c.first}/${e}/${t}?columns=${o.join(",")}`;return[r,r.replace(c.first,c.second)]}async function E(e,t=!1){return`${c.first}${e}`.replace(C,(r,n,i)=>`${n}/${t?"hq/":""}${i}.png`)}function b(e){const t=f.jobEnumToJob(e),o=f.nameToFullName(t);return`${c.first}/cj/companion/${o.en.toLowerCase().replaceAll(/\s/g,"")}.png`}async function j(e){const t=await T("action",e,["Icon"]);return E(t.Icon)}async function v(e){var r;const t=w.get(e);if(t)return{ActionCategoryTargetID:0,ID:0,Icon:t};const o=l.find(n=>n.name===e);if(o!=null&&o.action)return o.action;try{const u=(r=(await(await p([`https://${a.cafe}/search?filters=ClassJobLevel>0&indexes=action&string=${encodeURIComponent(e)}`])).json()).Results)==null?void 0:r[0];if(u){const g=Date.now()+I.random,d={name:e,action:u,expirationTime:g};return l.push(d),localStorage.setItem(m,JSON.stringify(l)),u}return{ActionCategoryTargetID:0,ID:0,Icon:"/i/000000/000405.png"}}catch(n){throw console.error(`Failed to get action by name: ${n}`),new Error("Failed to retrieve action data")}}async function x(e,t){let o;const r=new Promise((n,i)=>{o=setTimeout(()=>{i(new Error("Promise timed out"))},t)});return Promise.race([e,r]).finally(()=>{clearTimeout(o)})}async function p(e,t){const o=Object.assign({cache:"force-cache"},t);for(const r of e)try{const n=await x(fetch(r,o),3e3);if(n.ok)return n}catch(n){console.error(`Failed to fetch ${r}: ${n}`)}throw new Error("All fetch attempts failed.")}function N(e){const t=e.target;t.src.includes(c.first)?t.src=t.src.replace(c.first,c.second):t.src.includes(c.second)&&(t.src="")}export{E as a,b,j as c,v as g,N as h,T as p,c as s};
